#####
#
# This is a slapd.conf file.  See slapd.conf(5) for more info.
#
# Generated by Chef for <%= node['fqdn'] %>
#
####


# TLS configuration
TLSVerifyClient  allow
TLSCertificateFile     /etc/ldap/ssl/ldap_server_crt.pem
TLSCertificateKeyFile  /etc/ldap/ssl/ldap_server_key.pem
TLSCACertificateFile   /etc/ldap/ssl/team01_root_ca.pem

#force tls
security  tls=1

# Schema and objectClass definitions
include         /etc/ldap/schema/core.schema
include         /etc/ldap/schema/cosine.schema
include         /etc/ldap/schema/nis.schema
include         /etc/ldap/schema/inetorgperson.schema
include         /etc/ldap/schema/autofs.schema

# Where the pid file is put. The init.d script
# will not stop the server if you change this.
pidfile         /var/run/slapd/slapd.pid

# List of arguments that were passed to the server
argsfile        /var/run/slapd/slapd.args

# Read slapd.conf(5) for possible values
loglevel        0

# Where the dynamically loaded modules are stored
modulepath	/usr/lib/ldap
moduleload	back_hdb

# The maximum number of entries that is returned for a search operation
sizelimit 500

# The tool-threads parameter sets the actual amount of cpu's that is used
# for indexing.
tool-threads 1

#######################################################################
# Specific Backend Directives for hdb:
# Backend specific directives apply to this backend until another
# 'backend' directive occurs
backend		hdb

#####
# Database
#####
database        hdb
suffix          "<%= @basedn %>"
rootdn          "<%= @rootdn %>"
rootpw		      <%= @rootpw %>
directory       "/var/lib/ldap"
lastmod         on

dbconfig set_cachesize 0 31457280 0

# Number of objects that can be locked at the same time.
dbconfig set_lk_max_objects 1500
# Number of locks (both requested and granted)
dbconfig set_lk_max_locks 1500
# Number of lockers
dbconfig set_lk_max_lockers 1500

##
# Indexes
##
#index default pres,eq,approx,sub
#index objectClass eq
#index cn,ou,sn,uid,l,mail,gecos,memberUid,description
#index loginShell,homeDirectory pres,eq,approx
#index uidNumber,gidNumber pres,eq

index   objectClass             eq
index   cn                      pres,sub,eq
index   sn                      pres,sub,eq
index   uid                     pres,sub,eq
index   displayName             pres,sub,eq
index   default                 sub
index   uidNumber               eq
index   gidNumber               eq
index   mail,givenName          eq,subinitial
index   dc                      eq


# The userPassword by default can be changed
# by the entry owning it if they are authenticated.
# Others should not be able to see it, except the
# admin entry below
# These access lines apply to database #1 only
access to attrs=userPassword,shadowLastChange
        by group.exact="cn=administrators,<%= @basedn %>" write
        by dn="cn=syncrole,<%= @basedn %>" read
        by anonymous auth
        by self write
        by * none

# Ensure read access to the base for things like
# supportedSASLMechanisms.  Without this you may
# have problems with SASL not knowing what
# mechanisms are available and the like.
# Note that this is covered by the 'access to *'
# ACL below too but if you change that as people
# are wont to do you'll still need this if you
# want SASL (and possible other things) to work
# happily.
access to dn.base="" by * read


# The admin dn has full write access, everyone else
# can read everything.
access to *
        by group.exact="cn=administrators,<%= @basedn %>" write
        by dn="cn=syncrole,<%= @basedn %>" read
        by users read

access to *
        by dn.exact="cn=readUser,<%= @basedn %>" read
